<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>ThanhBinh49 AI Pro</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<style>
/* --- Reset & Font --- */
*{margin:0;padding:0;box-sizing:border-box;font-family:'Inter',sans-serif;-webkit-tap-highlight-color:transparent;}
body{background:#f5f5f7;color:#1E1E2F;display:flex;flex-direction:column;height:100vh;overflow:hidden;}

/* --- Header --- */
header{background:#1E1E2F;color:white;padding:14px 20px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 5px rgba(0,0,0,0.3);}
header h1{font-size:1.5rem;}
header button{background:#4ECDC4;border:none;border-radius:6px;padding:6px 10px;color:white;font-weight:bold;font-size:0.9rem;cursor:pointer;transition:0.2s;}
header button:hover{background:#3bb3a2;}

/* --- Main Layout --- */
main{flex:1;display:flex;overflow:hidden;}
#sidebar{width:280px;background:#2C2C3E;color:white;padding:15px;display:flex;flex-direction:column;gap:10px;overflow-y:auto;box-shadow:2px 0 5px rgba(0,0,0,0.2);}
#sidebar button,input[type=text],input[type=range]{border:none;border-radius:6px;padding:8px;font-weight:bold;font-size:0.9rem;cursor:pointer;transition:0.2s;}
#sidebar button{background:#4ECDC4;color:white;}
#sidebar button:hover{background:#3bb3a2;}
.slider-container{display:flex;flex-direction:column;gap:4px;}
.filter-btn{background:#FF6B6B;color:white;padding:8px;font-weight:bold;font-size:0.9rem;cursor:pointer;border-radius:5px;transition:0.2s;}
.filter-btn:hover{background:#e35a5a;}

/* --- Canvas --- */
#canvas-container{flex:1;background:#fff;display:flex;justify-content:center;align-items:center;position:relative;overflow:hidden;}
#editor{border:2px solid #1E1E2F;border-radius:6px;touch-action:none;max-width:100%;max-height:100%;}

/* --- Chat --- */
#chat-box{flex:1;background:#fff;color:#000;padding:8px;overflow-y:auto;height:180px;border-radius:6px;margin-top:5px;font-size:0.85rem;}
#chat-input{width:100%;padding:6px;border-radius:5px;border:1px solid #ccc;margin-top:5px;}

/* --- Footer --- */
footer{background:#1E1E2F;color:white;text-align:center;padding:10px;font-size:0.85rem;box-shadow:0 -2px 5px rgba(0,0,0,0.3);}

/* --- Responsive --- */
@media(max-width:768px){
  main{flex-direction:column;}
  #sidebar{width:100%;height:50vh;}
  #canvas-container{height:50vh;}
}
</style>
</head>
<body>

<header>
<h1>ThanhBinh49 AI Pro</h1>
<button onclick="location.reload()">Tải lại</button>
</header>

<main>
<div id="sidebar">
<button onclick="uploadImage()">Tải ảnh lên</button>

<div class="slider-container">
<label>Độ sáng</label>
<input type="range" id="brightness" min="0" max="200" value="100" oninput="applyFilters()">
</div>
<div class="slider-container">
<label>Độ tương phản</label>
<input type="range" id="contrast" min="0" max="200" value="100" oninput="applyFilters()">
</div>
<div class="slider-container">
<label>Độ bão hòa</label>
<input type="range" id="saturation" min="0" max="200" value="100" oninput="applyFilters()">
</div>

<label>Bộ lọc sẵn</label>
<button class="filter-btn" onclick="applyPreset('none')">Mặc định</button>
<button class="filter-btn" onclick="applyPreset('warm')">Ấm áp</button>
<button class="filter-btn" onclick="applyPreset('cool')">Lạnh</button>
<button class="filter-btn" onclick="applyPreset('cinematic')">Điện ảnh</button>
<button class="filter-btn" onclick="applyPreset('mono')">Đen trắng</button>

<hr>

<label>Xoay / Lật</label>
<button onclick="rotateCanvas(90)">Xoay 90°</button>
<button onclick="rotateCanvas(180)">Xoay 180°</button>
<button onclick="flipCanvas('horizontal')">Lật ngang</button>
<button onclick="flipCanvas('vertical')">Lật dọc</button>

<hr>

<label>Xóa nền thủ công</label>
<input type="range" id="brushSize" min="5" max="50" value="10">
<button onclick="applyRemoveMask()">Xóa nền</button>
<button onclick="undoMask()">Undo mask</button>

<hr>

<label>Tạo ảnh từ văn bản</label>
<input type="text" id="textPrompt" placeholder="Nhập mô tả...">
<button onclick="generateFromText()">Tạo ảnh</button>

<hr>

<label>Trợ lý AI</label>
<div id="chat-box"></div>
<input type="text" id="chat-input" placeholder="Nhập câu hỏi..." onkeydown="if(event.key==='Enter'){sendChat()}">
<button onclick="sendChat()">Gửi</button>

<hr>

<button onclick="undo()">Hoàn tác</button>
<button onclick="redo()">Làm lại</button>
<button onclick="downloadImage()">Lưu ảnh</button>
</div>

<div id="canvas-container">
<canvas id="editor"></canvas>
</div>
</main>

<footer>ThanhBinh49 AI Pro - iPhone friendly + Mobile App Style</footer>

<input type="file" id="fileInput" style="display:none" accept="image/*">

<script>
/* --- Core Variables --- */
let canvas=document.getElementById('editor'), ctx=canvas.getContext('2d'), img=new Image();
let history=[],historyIndex=-1, maskHistory=[], maskHistoryIndex=-1;
let currentPreset='none', brushSize=10;
let maskPixels=[], isMasking=false;

/* --- Upload --- */
function uploadImage(){ document.getElementById('fileInput').click(); }
document.getElementById('fileInput').onchange=function(e){
  let file=e.target.files[0], reader=new FileReader();
  reader.onload=function(ev){
    img.onload=function(){
      canvas.width=img.width>1000?1000:img.width;
      canvas.height=img.height>700?700:img.height;
      ctx.drawImage(img,0,0,canvas.width,canvas.height);
      saveHistory();
    }
    img.src=ev.target.result;
  }
  reader.readAsDataURL(file);
}

/* --- Filters & Presets --- */
function applyFilters(){
  if(!img.src) return;
  ctx.drawImage(img,0,0,canvas.width,canvas.height);
  let b=document.getElementById('brightness').value/100,
      c=document.getElementById('contrast').value/100,
      s=document.getElementById('saturation').value/100;
  let imgData=ctx.getImageData(0,0,canvas.width,canvas.height);
  let d=imgData.data;
  for(let i=0;i<d.length;i+=4){
    d[i]*=b; d[i+1]*=b; d[i+2]*=b;
    d[i]=((d[i]-128)*c)+128; d[i+1]=((d[i+1]-128)*c)+128; d[i+2]=((d[i+2]-128)*c)+128;
    let avg=(d[i]+d[i+1]+d[i+2])/3;
    d[i]=avg+(d[i]-avg)*s; d[i+1]=avg+(d[i+1]-avg)*s; d[i+2]=avg+(d[i+2]-avg)*s;
  }
  ctx.putImageData(imgData,0,0);
  applyPreset(currentPreset);
  saveHistory();
}

function applyPreset(name){
  currentPreset=name;
  if(!img.src) return;
  let imgData=ctx.getImageData(0,0,canvas.width,canvas.height);
  let d=imgData.data;
  for(let i=0;i<d.length;i+=4){
    let r=d[i],g=d[i+1],b=d[i+2];
    switch(name){
      case 'warm': d[i]+=20; d[i+1]+=10; break;
      case 'cool': d[i]-=10; d[i+1]-=5; d[i+2]+=20; break;
      case 'cinematic': d[i]*=1.1; d[i+1]*=0.95; d[i+2]*=0.9; break;
      case 'mono': let avg=(r+g+b)/3; d[i]=d[i+1]=d[i+2]=avg; break;
    }
  }
  ctx.putImageData(imgData,0,0);
  saveHistory();
}

/* --- Undo / Redo --- */
function saveHistory(){ if(historyIndex<history.length-1) history.splice(historyIndex+1); history.push(canvas.toDataURL()); historyIndex=history.length-1; }
function undo(){ if(historyIndex>0){ historyIndex--; loadHistory(); } }
function redo(){ if(historyIndex<history.length-1){ historyIndex++; loadHistory(); } }
function loadHistory(){ let imgH=new Image(); imgH.src=history[historyIndex]; imgH.onload=()=>{ ctx.drawImage(imgH,0,0,canvas.width,canvas.height); } }

/* --- Canvas Transform --- */
function rotateCanvas(deg){
  if(!img.src) return;
  const tempCanvas=document.createElement('canvas');
  const tCtx=tempCanvas.getContext('2d');
  if(deg%180===0){ tempCanvas.width=canvas.width; tempCanvas.height=canvas.height; }
  else{ tempCanvas.width=canvas.height; tempCanvas.height=canvas.width; }
  tCtx.translate(tempCanvas.width/2,tempCanvas.height/2);
  tCtx.rotate(deg*Math.PI/180);
  tCtx.drawImage(canvas,-canvas.width/2,-canvas.height/2);
  canvas.width=tempCanvas.width; canvas.height=tempCanvas.height;
  ctx.drawImage(tempCanvas,0,0);
  saveHistory();
}
function flipCanvas(dir){
  if(!img.src) return;
  ctx.save();
  if(dir==='horizontal'){ ctx.translate(canvas.width,0); ctx.scale(-1,1); }
  else{ ctx.translate(0,canvas.height); ctx.scale(1,-1); }
  ctx.drawImage(canvas,0,0);
  ctx.restore();
  saveHistory();
}

/* --- Mask / Xóa nền --- */
canvas.addEventListener('pointerdown',e=>{ isMasking=true; drawMask(e); });
canvas.addEventListener('pointermove',e=>{ if(isMasking) drawMask(e); });
canvas.addEventListener('pointerup',()=>{ isMasking=false; });

function drawMask(e){
  const rect=canvas.getBoundingClientRect();
  const x=Math.floor((e.clientX-rect.left)*(canvas.width/rect.width));
  const y=Math.floor((e.clientY-rect.top)*(canvas.height/rect.height));
  maskPixels.push({x,y});
  brushSize=parseInt(document.getElementById('brushSize').value);
  ctx.fillStyle='rgba(255,0,0,0.5)';
  ctx.beginPath(); ctx.arc(x,y,brushSize,0,Math.PI*2); ctx.fill();
}
function applyRemoveMask(){
  if(maskPixels.length===0) return alert("Chọn vùng đỏ muốn xóa!");
  const imgData=ctx.getImageData(0,0,canvas.width,canvas.height);
  maskPixels.forEach(p=>{
    for(let i=-brushSize;i<=brushSize;i++){
      for(let j=-brushSize;j<=brushSize;j++){
        let xx=p.x+i,yy=p.y+j;
        if(xx>=0&&xx<canvas.width&&yy>=0&&yy<canvas.height){
          const idx=(yy*canvas.width+xx)*4;
          imgData.data[idx+3]=0;
        }
      }
    }
  });
  ctx.putImageData(imgData,0,0);
  maskHistory.push(maskPixels.slice()); maskHistoryIndex=maskHistory.length-1;
  maskPixels=[];
  saveHistory();
}
function undoMask(){
  if(maskHistoryIndex>=0){
    maskHistoryIndex--;
    ctx.drawImage(img,0,0,canvas.width,canvas.height);
  }
}

/* --- Download --- */
function downloadImage(){ let a=document.createElement('a'); a.download="ThanhBinh49-Pro.png"; a.href=canvas.toDataURL(); a.click(); }

/* --- Text-to-Image & Chat AI Placeholder --- */
function generateFromText(){ alert("Gemini / OpenAI cần server proxy để hoạt động"); }
function sendChat(){ alert("Gemini / OpenAI cần server proxy để hoạt động"); }

</script>

</body>
</html>
