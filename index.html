<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ThanhBinh49 AI Pro</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0a0a0a">
    <style>
        :root { --primary: #007aff; --bg: #0a0a0a; --card: #1c1c1e; --text: #ffffff; }
        body { margin: 0; font-family: -apple-system, system-ui; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        header { padding: 15px; text-align: center; border-bottom: 1px solid #333; font-weight: 800; color: var(--primary); }
        .canvas-section { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 10px; position: relative; }
        canvas { max-width: 100%; max-height: 75%; border-radius: 12px; background: #111; box-shadow: 0 5px 20px rgba(0,0,0,0.5); }
        .loading { opacity: 0.4; filter: blur(5px); }
        .toolbar { display: flex; gap: 8px; overflow-x: auto; padding: 15px 10px; width: 100%; }
        button { background: var(--card); color: white; border: 1px solid #333; padding: 10px 18px; border-radius: 12px; white-space: nowrap; font-weight: 600; }
        button:active { background: var(--primary); }
        .btn-main { background: var(--primary); border: none; width: calc(100% - 20px); margin: 0 10px 10px 10px; padding: 14px; border-radius: 12px; font-weight: bold; color: white; }
        .chat-section { height: 180px; background: var(--card); margin: 0 10px 15px 10px; border-radius: 20px; display: flex; flex-direction: column; border: 1px solid #333; }
        #chat-history { flex: 1; overflow-y: auto; padding: 12px; font-size: 0.85rem; }
        .input-group { display: flex; padding: 8px; border-top: 1px solid #333; gap: 8px; }
        input { flex: 1; background: #2c2c2e; border: none; padding: 10px 15px; border-radius: 20px; color: white; outline: none; }
    </style>
</head>
<body>

<header>THANHBINH49 AI PRO</header>

<div class="canvas-section">
    <canvas id="mainCanvas"></canvas>
    <div class="toolbar">
        <button onclick="document.getElementById('fileInput').click()">üìÇ M·ªü ·∫£nh</button>
        <button onclick="applyFilter('boost')">üî• Boost</button>
        <button onclick="applyFilter('fantasy')">ü¶Ñ Fantasy</button>
        <button onclick="applyFilter('warm')">üçÇ Warm</button>
        <button onclick="resetImage()">üîÑ Reset</button>
    </div>
    <input type="file" id="fileInput" hidden accept="image/*" onchange="loadFile(event)">
    <button class="btn-main" onclick="saveImage()">XU·∫§T ·∫¢NH AI PRO</button>
</div>

<div class="chat-section">
    <div id="chat-history"><i>Ch√†o anh B√¨nh! G√µ l·ªánh v·∫Ω ho·∫∑c t√¢m s·ª± ƒëi ·∫°...</i></div>
    <div class="input-group">
        <input type="text" id="chatInput" placeholder="V·∫Ω m·ªôt con r·ªìng...">
        <button onclick="handleAI()" style="background:var(--primary); border:none; border-radius:50%; width:40px;">üöÄ</button>
    </div>
</div>

<script>
    const canvas = document.getElementById('mainCanvas');
    const ctx = canvas.getContext('2d');
    let originalImg = null;

    // 1. M·ªü ·∫£nh t·ª´ m√°y
    function loadFile(event) {
        const reader = new FileReader();
        reader.onload = function() {
            const img = new Image();
            img.onload = function() {
                const scale = (window.innerWidth - 40) / img.width;
                canvas.width = window.innerWidth - 40;
                canvas.height = img.height * scale;
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                originalImg = img;
            }
            img.src = reader.result;
        }
        reader.readAsDataURL(event.target.files[0]);
    }

    // 2. Ch·ªânh ·∫£nh (Fix l·ªói filter kh√¥ng ƒÉn)
    function applyFilter(mode) {
        if (!originalImg) return alert("Ch∆∞a c√≥ ·∫£nh s·∫øp ∆°i!");
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        if (mode === 'boost') ctx.filter = 'contrast(1.5) saturate(1.5)';
        else if (mode === 'fantasy') ctx.filter = 'hue-rotate(90deg) saturate(2)';
        else if (mode === 'warm') ctx.filter = 'sepia(0.5) brightness(1.1)';
        else ctx.filter = 'none';
        
        ctx.drawImage(originalImg, 0, 0, canvas.width, canvas.height);
        ctx.filter = 'none'; // Reset filter cho l·∫ßn sau
    }

    function resetImage() { 
        if(originalImg) {
            ctx.filter = 'none';
            ctx.drawImage(originalImg, 0, 0, canvas.width, canvas.height); 
        }
    }

    // 3. AI V·∫Ω ·∫£nh & Chat (Fix l·ªói API)
    async function handleAI() {
        const input = document.getElementById('chatInput');
        const text = input.value.trim();
        if (!text) return;
        
        addLog("B·∫°n", text);
        input.value = '';

        if (text.toLowerCase().includes("v·∫Ω")) {
            addLog("AI", "Em ƒëang v·∫Ω, s·∫øp ƒë·ª£i t√≠...");
            canvas.classList.add('loading');
            
            const img = new Image();
            img.crossOrigin = "anonymous";
            img.src = `https://pollinations.ai/p/${encodeURIComponent(text)}?width=1024&height=1024&seed=${Math.random()}`;
            
            img.onload = function() {
                canvas.classList.remove('loading');
                const scale = (window.innerWidth - 40) / img.width;
                canvas.width = window.innerWidth - 40;
                canvas.height = img.height * scale;
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                originalImg = img;
                addLog("AI", "Xong r·ªìi! S·∫øp th·∫•y ƒë·∫πp kh√¥ng?");
                speak("Xong r·ªìi n√® s·∫øp ∆°i");
            };
        } else {
            const reply = "D·∫° em nghe n√® anh B√¨nh Pro!";
            addLog("AI", reply);
            speak(reply);
        }
    }

    function addLog(s, m) {
        const d = document.createElement('div');
        d.innerHTML = `<b>${s}:</b> ${m}`;
        document.getElementById('chat-history').appendChild(d);
        document.getElementById('chat-history').scrollTop = 9999;
    }

    function speak(t) {
        const u = new SpeechSynthesisUtterance(t);
        u.lang = 'vi-VN';
        window.speechSynthesis.speak(u);
    }

    function saveImage() {
        const a = document.createElement('a');
        a.download = 'TB49_AI.png';
        a.href = canvas.toDataURL();
        a.click();
    }

    if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
</script>
</body>
</html>
