<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TB49 ULTIMATE AI</title>
    <style>
        :root { --tiktok-pink: #fe2c55; --tiktok-cyan: #25f4ee; --glass: rgba(255, 255, 255, 0.1); }
        body { margin: 0; background: #000; color: #fff; font-family: -apple-system, system-ui, sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* Header */
        .header { display: flex; justify-content: space-between; padding: 10px 15px; align-items: center; background: rgba(0,0,0,0.8); border-bottom: 1px solid #222; }
        .logo { font-weight: 900; font-size: 1.1rem; color: #fff; }
        .logo span { color: var(--tiktok-pink); }

        /* Camera & Canvas View */
        #main-view { flex: 1; position: relative; background: #050505; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        video, canvas { max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 15px; }
        
        /* Indicators */
        .rec-dot { position: absolute; top: 20px; right: 20px; width: 12px; height: 12px; background: red; border-radius: 50%; display: none; animation: blink 1s infinite; z-index: 10; }
        @keyframes blink { 50% { opacity: 0; } }

        /* Floating Controls */
        .side-tools { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); display: flex; flex-direction: column; gap: 15px; z-index: 20; }
        .tool-btn { background: var(--glass); border: 1px solid #444; color: #fff; width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); }

        /* Cam Controls */
        .cam-actions { position: absolute; bottom: 20px; width: 100%; display: flex; justify-content: center; align-items: center; gap: 30px; }
        .snap-btn { width: 65px; height: 65px; border-radius: 50%; background: #fff; border: 5px solid var(--tiktok-pink); }
        .snap-btn:active { transform: scale(0.9); }

        /* Filter Slider */
        .filter-scroll { display: flex; gap: 12px; overflow-x: auto; padding: 10px; background: #111; border-top: 1px solid #222; }
        .f-card { min-width: 65px; text-align: center; font-size: 10px; }
        .f-circle { width: 45px; height: 45px; border-radius: 50%; border: 2px solid #333; margin: 0 auto 5px; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .f-circle.active { border-color: var(--tiktok-cyan); color: var(--tiktok-cyan); }

        /* Chatbox */
        #chat-area { height: 180px; background: #000; display: flex; flex-direction: column; border-top: 1px solid #222; }
        #log { flex: 1; overflow-y: auto; padding: 10px; font-size: 13px; color: #bbb; line-height: 1.5; }
        .input-group { display: flex; padding: 10px; gap: 10px; background: #0a0a0a; padding-bottom: calc(10px + env(safe-area-inset-bottom)); }
        input { flex: 1; background: #222; border: none; color: #fff; padding: 12px 18px; border-radius: 25px; outline: none; }
        .send-btn { background: var(--tiktok-pink); border: none; width: 40px; height: 40px; border-radius: 50%; color: white; }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">TB49 <span>ULTIMATE</span></div>
        <div style="display:flex; gap:10px;">
            <button onclick="document.getElementById('file-in').click()" style="background:none; border:1px solid #444; color:#fff; border-radius:5px; font-size:12px; padding:5px 8px;">üìÇ FILE</button>
            <button onclick="boom()" style="background:red; border:none; color:#fff; border-radius:5px; font-size:12px; padding:5px 8px;">‚ò¢Ô∏è H·ª¶Y</button>
        </div>
    </div>

    <div id="main-view">
        <div class="rec-dot" id="recDot"></div>
        <video id="v" autoplay playsinline style="display:none;"></video>
        <canvas id="c"></canvas>
        
        <div class="side-tools">
            <button class="tool-btn" onclick="switchCam()">üîÑ</button>
            <button class="tool-btn" onclick="toggleCam()">üì∑</button>
            <button class="tool-btn" onclick="sv()">üíæ</button>
        </div>

        <div class="cam-actions">
            <button onclick="rec(true)" style="color:red; font-size:24px; background:none; border:none;">‚è∫Ô∏è</button>
            <button class="snap-btn" onclick="snap()"></button>
            <button onclick="rec(false)" style="color:white; font-size:24px; background:none; border:none;">‚èπÔ∏è</button>
        </div>
    </div>

    <div class="filter-scroll">
        <div class="f-card" onclick="setF('normal', this)"><div class="f-circle active">G·ªëc</div>Normal</div>
        <div class="f-card" onclick="setF('magic', this)"><div class="f-circle" style="color:gold">·∫¢o</div>Magic</div>
        <div class="f-card" onclick="setF('retro', this)"><div class="f-circle" style="color:gray">C·ªï</div>Retro</div>
        <div class="f-card" onclick="setF('pink', this)"><div class="f-circle" style="color:pink">H·ªìng</div>Rosy</div>
        <div class="f-card" onclick="setF('deep', this)"><div class="f-circle" style="color:cyan">S·∫Øc</div>Deep</div>
    </div>

    <div id="chat-area">
        <div id="log">AI: T·∫•t c·∫£ ƒë√£ s·∫µn s√†ng th∆∞a s·∫øp B√¨nh! Ch·ª•p, Quay, V·∫Ω hay Chat?</div>
        <div class="input-group">
            <input type="text" id="m" placeholder="Chat ho·∫∑c 'v·∫Ω xe ng·ª±a'...">
            <button onclick="go()" class="send-btn">üöÄ</button>
        </div>
    </div>

    <input type="file" id="file-in" hidden onchange="ld(event)">

<script>
    const KEY = "AIzaSyAosEJtRm3eHM-zVmsIzAMfipoU3v9wEek";
    const video = document.getElementById('v'), cv = document.getElementById('c'), x = cv.getContext('2d');
    let stream, recorder, chunks = [], curF = 'normal', ori = null;

    async function start(mode = 'environment') {
        try {
            if(stream) stream.getTracks().forEach(t => t.stop());
            stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: mode }, audio: true });
            video.srcObject = stream;
            video.style.display = 'block';
            video.onloadedmetadata = () => { cv.width = video.videoWidth; cv.height = video.videoHeight; draw(); };
        } catch(e) { msg("AI", "L·ªói cam: " + e); }
    }

    function draw() {
        if(video.paused || video.ended) return;
        x.drawImage(video, 0, 0, cv.width, cv.height);
        applyF();
        requestAnimationFrame(draw);
    }

    function applyF() {
        if(curF === 'normal') return;
        const d = x.getImageData(0,0,cv.width,cv.height), data = d.data;
        for(let i=0; i<data.length; i+=4) {
            if(curF === 'magic') { data[i]*=1.3; data[i+1]*=1.2; }
            if(curF === 'retro') { let g=(data[i]+data[i+1]+data[i+2])/3; data[i]=g+40; data[i+1]=g; data[i+2]=g-20; }
            if(curF === 'pink') { data[i]+=30; data[i+2]+=20; }
            if(curF === 'deep') { data[i]=(data[i]-128)*1.5+128; data[i+1]=(data[i+1]-128)*1.5+128; data[i+2]=(data[i+2]-128)*1.5+128; }
        }
        x.putImageData(d, 0, 0);
    }

    function setF(f, el) {
        curF = f;
        document.querySelectorAll('.f-circle').forEach(b => b.classList.remove('active'));
        el.querySelector('.f-circle').classList.add('active');
        if(ori) { x.drawImage(ori,0,0,cv.width,cv.height); applyF(); }
    }

    function switchCam() {
        const mode = video.srcObject.getVideoTracks()[0].getSettings().facingMode === 'user' ? 'environment' : 'user';
        start(mode);
    }

    function toggleCam() { video.style.display = 'block'; ori = null; msg("AI", "Live Camera!"); }

    function snap() {
        video.style.display = 'none';
        const img = new Image();
        img.src = cv.toDataURL();
        img.onload = () => { ori = img; msg("AI", "ƒê√£ ch·ª•p! S·∫øp c√≥ th·ªÉ ch·ªânh Filter."); };
    }

    function rec(on) {
        if(on) {
            chunks = [];
            recorder = new MediaRecorder(stream);
            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = () => {
                const blob = new Blob(chunks, { type: 'video/mp4' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = 'tb49_video.mp4'; a.click();
            };
            recorder.start();
            document.getElementById('recDot').style.display = 'block';
            msg("AI", "ƒêang quay phim s·ªëng ·∫£o...");
        } else {
            recorder.stop();
            document.getElementById('recDot').style.display = 'none';
        }
    }

    function ld(e) {
        const r = new FileReader();
        r.onload = ev => {
            const img = new Image();
            img.onload = () => {
                video.style.display = 'none';
                cv.width = img.width; cv.height = img.height;
                x.drawImage(img, 0, 0); ori = img; applyF();
                msg("AI", "ƒê√£ n·∫°p ·∫£nh t·ª´ m√°y s·∫øp.");
            };
            img.src = ev.target.result;
        };
        r.readAsDataURL(e.target.files[0]);
    }

    function sv() { const a = document.createElement('a'); a.download = 'tb49_art.png'; a.href = cv.toDataURL(); a.click(); }
    function boom() { if(confirm("H·ªßy h·∫øt?")) { x.clearRect(0,0,cv.width,cv.height); if(stream) stream.getTracks().forEach(t=>t.stop()); msg("AI","B√ôM!"); } }

    async function go() {
        const i = document.getElementById('m'), v = i.value.trim();
        if(!v) return; msg("S·∫øp", v); i.value = '';
        if(v.toLowerCase().includes("v·∫Ω")) {
            msg("AI", "ƒêang m√∫a c·ªç...");
            const aimg = new Image(); aimg.crossOrigin = "anonymous";
            aimg.src = `https://pollinations.ai/p/${encodeURIComponent(v)}?width=800&height=1200&model=flux&seed=${Math.random()}`;
            aimg.onload = () => {
                video.style.display = 'none'; cv.width = 800; cv.height = 1200;
                x.drawImage(aimg, 0, 0, 800, 1200); ori = aimg; msg("AI", "Tranh s·∫øp y√™u c·∫ßu ƒë√¢y!");
            };
        } else {
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${KEY}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: v }] }] })
                });
                const d = await res.json();
                const txt = d.candidates[0].content.parts[0].text;
                msg("AI", txt);
                const s = new SpeechSynthesisUtterance(txt.substring(0, 150)); s.lang = 'vi-VN'; window.speechSynthesis.speak(s);
            } catch(e) { msg("AI", "Gemini h·∫Øt h∆°i r·ªìi!"); }
        }
    }

    function msg(s, m) {
        const l = document.getElementById('log');
        l.innerHTML += `<div><b style="color:var(--tiktok-cyan)">${s}:</b> ${m}</div>`;
        l.scrollTop = l.scrollHeight;
    }

    window.onload = () => start();
</script>
</body>
</html>
