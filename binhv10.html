<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
<title>TB49 V15 REAL AI FINAL</title>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/face-detection"></script>

<style>
:root{--p:#00ff88;--bg:#0a0a0a}
body{margin:0;font-family:system-ui;background:var(--bg);color:#fff;display:flex;flex-direction:column;height:100vh}
#vp{flex:1;display:flex;align-items:center;justify-content:center;background:#000;position:relative}
#msg{position:absolute;top:10px;color:var(--p);font-weight:800;font-size:14px}
canvas{max-width:100%;max-height:70vh;border:1px solid #333}
.controls{background:#151515;padding:14px;border-top:2px solid var(--p);display:flex;gap:10px;flex-wrap:wrap}
.btn{flex:1;min-width:120px;padding:14px;border:none;border-radius:14px;font-weight:900;font-size:15px}
.ai{background:var(--p);color:#000}
.save{background:#333;color:#fff}
.file{background:#444;color:#fff;text-align:center}
.btn:active{transform:scale(.96)}
</style>
</head>

<body>

<div id="vp">
  <div id="msg">CHỌN ẢNH</div>
  <canvas id="cv"></canvas>
</div>

<div class="controls">
  <button class="btn ai" onclick="runAI()">AI AUTO MAX</button>
  <button class="btn save" onclick="saveImg()">LƯU ẢNH</button>
  <label class="btn file">
    CHỌN ẢNH
    <input type="file" hidden accept="image/*" onchange="loadImg(event)">
  </label>
</div>

<script>
const cv = document.getElementById("cv");
const ctx = cv.getContext("2d");
const msg = document.getElementById("msg");

let img = null;
let base = null;
let detector = null;

/* ===== LOAD AI ===== */
(async()=>{
  detector = await faceDetection.createDetector(
    faceDetection.SupportedModels.MediaPipeFaceDetector,
    {runtime:"tfjs",maxFaces:1}
  );
})();

/* ===== LOAD IMAGE ===== */
function loadImg(e){
  const r = new FileReader();
  r.onload = v=>{
    img = new Image();
    img.onload = ()=>{
      cv.width = img.width;
      cv.height = img.height;
      ctx.drawImage(img,0,0);
      base = ctx.getImageData(0,0,cv.width,cv.height);
      msg.innerText = "ẢNH SẴN SÀNG";
    };
    img.src = v.target.result;
  };
  r.readAsDataURL(e.target.files[0]);
}

/* ===== CLAMP FACE BOX ===== */
function clampBox(b){
  return {
    x: Math.max(0, Math.floor(b.xMin)),
    y: Math.max(0, Math.floor(b.yMin)),
    w: Math.min(cv.width - b.xMin, Math.floor(b.width)),
    h: Math.min(cv.height - b.yMin, Math.floor(b.height))
  };
}

/* ===== MAIN AI ===== */
async function runAI(){
  if(!img || !detector) return;
  msg.innerText = "AI ĐANG XỬ LÝ…";

  ctx.putImageData(base,0,0);

  const faces = await detector.estimateFaces(img);
  if(!faces.length){
    msg.innerText = "KHÔNG THẤY MẶT";
    return;
  }

  const b = clampBox(faces[0].box);

  smoothSkin(b);
  youngTone(b);
  sharpenFace(b);
  globalTone();

  msg.innerText = "HOÀN TẤT ✅";
}

/* ===== SKIN SMOOTH (ADAPTIVE) ===== */
function smoothSkin(b){
  const imgD = ctx.getImageData(b.x,b.y,b.w,b.h);
  const d = imgD.data;

  for(let i=0;i<d.length;i+=4){
    const lum = (d[i]+d[i+1]+d[i+2])/3;
    if(lum>90 && lum<200){
      d[i]   = d[i]*0.78 + lum*0.22;
      d[i+1] = d[i+1]*0.78 + lum*0.22;
      d[i+2] = d[i+2]*0.78 + lum*0.22;
    }
  }
  ctx.putImageData(imgD,b.x,b.y);
}

/* ===== YOUNG MIDTONE ===== */
function youngTone(b){
  const imgD = ctx.getImageData(b.x,b.y,b.w,b.h);
  const d = imgD.data;

  for(let i=0;i<d.length;i+=4){
    const lum = (d[i]+d[i+1]+d[i+2])/3;
    if(lum>110 && lum<180){
      d[i]   += 8;
      d[i+1] += 6;
      d[i+2] += 3;
    }
  }
  ctx.putImageData(imgD,b.x,b.y);
}

/* ===== SHARPEN (SAFE) ===== */
function sharpenFace(b){
  const imgD = ctx.getImageData(b.x,b.y,b.w,b.h);
  const d = imgD.data;

  for(let i=0;i<d.length;i+=4){
    d[i]   = Math.min(255,d[i]*1.06 + 4);
    d[i+1] = Math.min(255,d[i+1]*1.06 + 4);
    d[i+2] = Math.min(255,d[i+2]*1.06 + 4);
  }
  ctx.putImageData(imgD,b.x,b.y);
}

/* ===== GLOBAL TONE ===== */
function globalTone(){
  const imgD = ctx.getImageData(0,0,cv.width,cv.height);
  const d = imgD.data;

  for(let i=0;i<d.length;i+=4){
    if(d[i]<230){
      d[i]   *= 1.04;
      d[i+1] *= 1.04;
      d[i+2] *= 1.04;
    }
  }
  ctx.putImageData(imgD,0,0);
}

/* ===== SAVE ===== */
function saveImg(){
  cv.toBlob(b=>{
    const a=document.createElement("a");
    a.href=URL.createObjectURL(b);
    a.download="TB49_AI_FINAL.jpg";
    a.click();
    URL.revokeObjectURL(a.href);
  },"image/jpeg",0.95);
}
</script>
</body>
</html>